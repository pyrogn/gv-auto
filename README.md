# Автоиграйка для тупайки Годвилль

Бот-самоиграйка для игры Годвилль. Возводим жанр Zero-player game до максимального состояния.

> [!WARNING]  
> Данный прокт предназначен только для образовательных целей. Его использование приведет к низкому качеству игры и блокировке аккаунта.

## Что он делает

Собирает золотые кирпичи быстрым и недонатным способом. Но если игра нравится, то советую задонатить.

Стратегии:
- Плавка кирпичей, если скопилось >3000 золота
- Заполнение бинго, если у героя >50% инвентаря, и получение купона
- Копание в поле (при низком здоровье, чтобы не откопать босса)
- Разворот в город, где можно подешевле купить кирпич
- Открытие определенных активируемых предметов (классы предметов определяет Erinome Godville UI+)
- Поход на ZPG-арену
- Отмена побега с гильдии
- Воскрешение героя (рутинная операция)

Что не реализовано:
- Крафт вещей (кнопки появляются благодаря Erinome Godville UI+, и несложно внедрить такую стратегию через поиск, два клика)
- Активация знаков (непонятно как различать нужные от ненужных)
- Сброс счетчика разворотов при выполнении мини-квеста (мало встречал, и непонятно, как определить положительное окончание квеста)
- Возможности выше 12 уровня (но и до постройки храма вроде ничего нового не появляется).
- Парсинг астропрогнозов и изменение стратегий (класс определяется расширением UI+).
- Работа с Верхним Ящиком. LLM пока плоховато разбираются юморе и не могут отличить хорошую от плохой идеи.

## Как это работает

Происходит управление браузером Chrome через фреймворк SeleniumBase со скрытым режимом в headless режиме (это удобно, но детектируемо). В коде описана логика обработки информации и принятия решений. То есть отдаются команды на взаимодействие со страницей (клики, заполнение текста).

<details>
  <summary>Примеры логов</summary>

Активашки
```
2024-06-25 01:23:14,913 - INFO - I have алоэ веры, class: type-charge-box, Этот предмет добавляет заряд в прано-аккумулятор (требуется 50% праны), price: 50
2024-06-25 01:23:14,962 - INFO - Activated this item
2024-06-25 01:23:16,250 - INFO - Hero's response: Внезапно алоэ веры превратило в сияющий синий брикетик, который стремительно унёсся куда-то вверх. Великий тоже собирает кирпичи?
```

Копание
```
2024-06-24 23:52:49,488 - INFO - Возврат|money:508|prana:61|inv:16|bricks:33|hp:11|where:7,В пути|town:Подмостква|quest:11,заставить летать рождённого ползать
2024-06-24 23:53:04,951 - INFO - Godvoice command 'Копай клад!' executed. Hero RESPONDED.
2024-06-24 23:53:04,952 - INFO - Digging strategy executed.
2024-06-24 23:53:53,249 - INFO - Возврат|money:508|prana:56|inv:16|bricks:33|hp:11|where:6,В пути|town:Нижние Котлы|quest:11,заставить летать рождённого ползать
2024-06-24 23:54:16,078 - INFO - Godvoice command 'Копай клад!' executed. Hero RESPONDED.
2024-06-24 23:54:16,079 - INFO - Digging strategy executed.
```

ZPG-арена
```
2024-06-24 22:00:17,180 - INFO - Accepted first confirm for arena
2024-06-24 22:00:18,014 - INFO - Went to ZPG arena: Ближайшие 2 мин 43 с арена работает в режиме полного ZPG, не позволяя богам влиять на героев. Вы готовы положиться на волю случая?
2024-06-24 22:00:18,015 - INFO - ZPG arena strategy executed.
2024-06-24 22:01:07,630 - INFO - Авантюра|money:1140|prana:25|inv:75|bricks:32|hp:100|where:0,Годвилль|town:Годвилль|quest:10,набрать выпускной бал
```

Плавка
```
2024-06-24 08:56:36,828 - INFO - Influence was made with 3 strategy
2024-06-24 08:56:36,828 - INFO - Influence action 'PUNISH' executed successfully.
2024-06-24 08:56:36,828 - INFO - Melt bricks strategy executed.
```

Бинго
```
2024-06-25 10:00:12,277 - INFO - Осталось игр в бинго: 3
2024-06-25 10:00:12,984 - INFO - Trying to play bingo and get coupon
2024-06-25 10:00:14,552 - INFO - Bingo played: Трофеев в инвентаре: 6. В бинго можно изъять: распрекраски.
2024-06-25 10:00:17,210 - INFO - Bingo strategy executed.
```

Возврат
```
2024-06-23 21:42:43,579 - INFO - Godvoice command 'Домой' executed. Hero RESPONDED.
2024-06-23 21:42:43,715 - INFO - Return counter: 1
2024-06-23 21:42:43,715 - INFO - Returning strategy executed.
```

</details>

## Краткая статистика

В чистом ZPG-режиме (без скриптом, но с ежедневными посещениями) 1000 кирпичей собирается около года. Это 3 кирпича в день (квесты, рыбалка, покупка).

А бот соберет примерно за 4 месяца.

Время жизни: 10 дней

(3 графика, статистика) из `just stats`

Зарядов: 16

Инвайтов + Другов: 8

Дуэлей: 14 (соперник находился в 50% отправок на дуэль)

## Это детектируется?

Сложнее, чем чистый селениум, но все равно **Да**. Источник - https://github.com/kaliiiiiiiiii/brotector
- Если использовать не на Linux, то детектируется headless режим отсутствием некоторых переменных. На Linux будет использоваться виртуальный дисплей, который не оставляет подобных артефактов для детекции (но он ужасно тяжелый при эмуляции на ARM).
- При скачивании страницы или даже при reconnect (отключение вебдрайвера и сон) вебдравер что-то делает с devtools и brotector это ловит (`runtime.enabled`).
- Ручное открытие devtools тоже выглядит подозрительно и детектируется.
- Поведенческие индикаторы (быстрая реакция, скриптовая реакция на похожие условия).

Можно маркировать пользователей, которые потенциально используют селениум, а далее смотреть на взаимодействие с сайтом. Это позволит определить всех автоматчиков.

## Как это запускать (по-прежнему не рекомендую это делать)

Для этого потребуется:

- `rye` (`rye sync`)
- `just` (доступный команды выведутся при выполнении `just`)
- Установленный Chrome
- логин и пароль в `.env` для работы автологина (либо вручную в хроме ввести)
- Внутри браузера надо вручную установить расширение Erinome Godville UI+, указать нужные настройки крафта
- `just auto` или другие рецепты в `justfile`

## Особенности

- При ошибках парсинга сохраняется исходный код и скриншот страницы. Выводится traceback питона.
- Легкое переключение между ручным, автоматическим с окном и автоматическим headless режимом (рецепты в `justfile`).
- Классы стараются выполнять только свою функцию, поэтому их немало, но так более понятно.
- Состояния (счетчик разворотов, бинго, время влияний и гласов) записываются в файл, чтобы при перезапуске корректно подгрузить прогресс. Профиль браузера переиспользуется.
- Тесты покрывают базовую часть, так как остальные сложней тестировать и писать их легче при честно протестированных базовых классах.
- Информация со страницы кэшируется (1 сек), чтобы ускорить проверку условий для стратегий.

## TODO:

- [x] Главный цикл с действиями, разобрать логику
- [x] test bingo+coupon strategy 100% auto
- [x] test gold melting strategy 100% auto
- [x] test zpg arena strategy 100% auto
- [x] test digging strategy 100% auto
- [x] Think about env vars like inventory (absolute or %), hp
- [x] Sleep logic and driver management (sleep, arena, random) (basic)
- [x] track godvoice responses, changes (basic)
- [x] ideabox parsing / analyzing / autoclick (won't do)
- [x] handling errors (screenshot + page_html + log)
- [x] parsing of response (basic text)
- [x] refactoring
- [x] decorators for tracking logic (saving, syncing)
- [x] benchmark parsing, what is faster (from html or seleniumbase)
- [x] can you detect seleniumbase (headless gets detected by HighEntropyValues)
- [x] test activatables opening 100% auto
- [x] test returning strategy 100% auto
- [x] unit tests

Optional:
- [x] use headful seleniumbase from docker: `--uc --headed --xvfb`
- [ ] crafting as a strategy (need manual testing first)
- [x] caching in activatables
- [x] speed up parsing by parsing from html or some sort of caching (think carefully)
- [ ] Saving progress to DB (with what purpose?)
- [ ] validation of elements in page, if something is wrong - notify or drop it


## **small** things
- is logging alright? I think that we might throw exceptions and catch them at the top.
- Is bot human enough?
- How to know if a player has finished a mini quest? What features can we use?

## Заметки

- Мини-квесты не увеличивают порядковый номер, но содержат подстроку: (мини). Выполненные содержат: (выполнено), не увеличивают номер сразу. Отмененные: ?. Эпик: (эпик)? Гильдийские: ?.
- В разных кирпичных городах разная цена кирпича
- Я бы активировал только Инвайт (для коллекции), другие полезности можно открывать, но много ли будет пользы?
- Для контроля за ответом героя, можно смотреть на последнюю запись, но она может быть перекрыта предыдущей
- При смене дня, если герой в городе, то корректный город находится в панели, а не на карте, и герой переносится вместе с городом (сейчас не совсем корректно).
  - arena normal: Отправить героя на арену для дуэли с другим игроком?
  - arena zpg: like normal, then: Ближайшие 1 мин 41 с арена работает в режиме полного ZPG, не позволяя богам влиять на героев. Вы готовы положиться на волю случая?
  - if late: alert closes, some obscure error emerges
- zpg арена тоже перемещает в Годвилль и выдает 3 предмета, иногда вдобавок кирпич
- mini:
  - quest:13,стать 325-м членом гильдии «Ряды Фурье»
  - quest:13,расширить суженого (мини) и следом разрядить ряженого (мини). Как их обрабатывать?



