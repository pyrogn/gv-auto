# Автоиграйка для тупайки Годвилль

Бот-самоиграйка для игры Годвилль. Возводим жанр Zero-player game до максимального состояния.

> [!WARNING]  
> Данный прокт предназначен только для образовательных целей. Его использование приведет к низкому удовлетворению от игры и блокировке аккаунта.

## Что он делает

Собирает золотые кирпичи быстрым и недонатным способом. Но если игра нравится, то советую задонатить, — демиурги сделали, поддерживают и развивают великолепную игру.

Стратегии:
- Плавка кирпичей, если скопилось >3000 золота
- Заполнение бинго, если у героя >=40% инвентаря, и получение купона
- Копание в поле (при низком здоровье, чтобы не откопать босса)
- Разворот в город, где можно подешевле купить кирпич
- Открытие определенных активируемых предметов (классы предметов определяет Erinome Godville UI+)
- Поход на ZPG-арену (если золота не очень много, и позади не кирпичный город)
- Отмена побега с гильдии
- Воскрешение героя (рутинная операция)

Что не реализовано:
- Крафт вещей (кнопки появляются благодаря Erinome Godville UI+, и несложно внедрить такую стратегию через поиск, два клика)
- Активация знаков (непонятно как различать нужные от ненужных)
- Сброс счетчика разворотов при выполнении мини-квеста (мало встречал, и непонятно, как достоверно определить положительное окончание квеста)
- Возможности выше 12 уровня (но и до постройки храма вроде ничего необычного не появляется).
- Парсинг астропрогнозов и изменение стратегий (класс определяется расширением UI+).
- Работа с Верхним Ящиком. LLM пока плоховато разбираются юморе и не могут отличить хорошую от плохой идеи.

## Как это работает

Происходит управление браузером Chrome через фреймворк SeleniumBase со скрытым режимом в headless режиме (это удобно, но детектируемо). В коде описана логика обработки информации и принятия решений. То есть отдаются команды на взаимодействие со страницей (клики, заполнение текста) при выполнении условий.

<details>
  <summary>Примеры логов работы стратегий</summary>

Активашки
```
2024-06-25 01:23:14,913 - INFO - I have алоэ веры, class: type-charge-box, Этот предмет добавляет заряд в прано-аккумулятор (требуется 50% праны), price: 50
2024-06-25 01:23:14,962 - INFO - Activated this item
2024-06-25 01:23:16,250 - INFO - Hero's response: Внезапно алоэ веры превратило в сияющий синий брикетик, который стремительно унёсся куда-то вверх. Великий тоже собирает кирпичи?
```

Копание
```
2024-06-24 23:52:49,488 - INFO - Возврат|money:508|prana:61|inv:16|bricks:33|hp:11|where:7,В пути|town:Подмостква|quest:11,заставить летать рождённого ползать
2024-06-24 23:53:04,951 - INFO - Godvoice command 'Копай клад!' executed. Hero RESPONDED.
2024-06-24 23:53:04,952 - INFO - Digging strategy executed.
2024-06-24 23:53:53,249 - INFO - Возврат|money:508|prana:56|inv:16|bricks:33|hp:11|where:6,В пути|town:Нижние Котлы|quest:11,заставить летать рождённого ползать
2024-06-24 23:54:16,078 - INFO - Godvoice command 'Копай клад!' executed. Hero RESPONDED.
2024-06-24 23:54:16,079 - INFO - Digging strategy executed.
```

ZPG-арена
```
2024-06-24 22:00:17,180 - INFO - Accepted first confirm for arena
2024-06-24 22:00:18,014 - INFO - Went to ZPG arena: Ближайшие 2 мин 43 с арена работает в режиме полного ZPG, не позволяя богам влиять на героев. Вы готовы положиться на волю случая?
2024-06-24 22:00:18,015 - INFO - ZPG arena strategy executed.
2024-06-24 22:01:07,630 - INFO - Авантюра|money:1140|prana:25|inv:75|bricks:32|hp:100|where:0,Годвилль|town:Годвилль|quest:10,набрать выпускной бал
```

Плавка кирпичей
```
2024-07-07 22:25:04,276 - INFO - Дорога|money:4084|prana:100|inv:14|bricks:149|hp:100|where:0,В пути|town:Годвилль|quest:32,найти носильщика для серьёзных отношений
2024-07-07 22:25:04,890 - INFO - Influence was made with 2 strategy
2024-07-07 22:25:04,890 - INFO - Influence action 'PUNISH' executed successfully.
2024-07-07 22:25:04,890 - INFO - Melt bricks strategy executed.
2024-07-07 22:26:06,063 - INFO - Дорога|money:1754|prana:75|inv:14|bricks:150|hp:100|where:1,В пути|town:Годвилль|quest:32,найти носильщика для серьёзных отношений
```

Бинго
```
2024-07-05 00:37:59,161 - INFO - Осталось игр в бинго: 3
2024-07-05 00:37:59,856 - INFO - Trying to play bingo and get coupon
2024-07-05 00:38:01,408 - INFO - Bingo played: Трофеев в инвентаре: 6. В бинго можно изъять: жесть доброй моли, микрогномикон.
2024-07-05 00:38:02,254 - INFO - Got coupon: КУПОН на сублиматор желаний
2024-07-05 00:38:04,860 - INFO - Bingo strategy executed.
```

Возврат
```
2024-07-05 18:05:51,944 - INFO - Godvoice command 'Домой' executed. Hero RESPONDED.
2024-07-05 18:05:52,074 - INFO - Return counter: 1
2024-07-05 18:05:52,075 - INFO - Returning strategy executed.
2024-07-05 18:06:02,429 - INFO - Возврат|money:2366|prana:37|inv:57|bricks:124|hp:18|where:45,В пути|town:Торгбург|quest:28,переиграть скелета в кости
```

</details>

## Статистика

В чистом ZPG-режиме (без скриптом, но с ежедневными посещениями) 1000 кирпичей собирается около года. Это 3 кирпича в день (квесты, рыбалка, покупка). 

Скрипт работал по 8-12 часов в день. И бот соберет кирпичи для храма примерно за 4 месяца (я более склонен верить линейному прогнозу).

![average_new_bricks_by_day](https://github.com/pyrogn/gv-auto/assets/60060559/dd0d0382-61e1-486f-8285-150f18a15895)
![projection_1000_bricks](https://github.com/pyrogn/gv-auto/assets/60060559/9f0a4429-0d4c-4cfb-9655-a2499a1e63b9)


Факты:
- В среднем за сутки собиралось 8 кирпичей
- Время жизни героя: 18 дней
- Дуэлей: 37 (соперник находился в 40% отправок на дуэль)
- Инвайтов + Другов: 12

## Это детектируется?

Сложнее, чем чистый селениум, но все равно **Да**. Источник - https://github.com/kaliiiiiiiiii/brotector
- Если использовать не на Linux, то детектируется headless режим отсутствием некоторых переменных. На Linux будет использоваться виртуальный дисплей, который не оставляет подобных артефактов для детекции (но он ужасно тяжелый при эмуляции на ARM).
- При скачивании страницы или даже при reconnect (отключение вебдрайвера и сон) вебдравер что-то делает с devtools и brotector это ловит (`runtime.enabled`).
- Ручное открытие devtools тоже выглядит подозрительно и детектируется.
- Поведенческие индикаторы (быстрая реакция, скриптовая реакция на похожие условия).

Можно маркировать пользователей, которые потенциально используют селениум, а далее смотреть на взаимодействие с сайтом. Это позволит определить всех автоматчиков.

## Как это запускать (по-прежнему не рекомендую это делать)

Для этого потребуется:

- `rye` (`rye sync`)
- `just` (доступные команды выведутся при выполнении `just`)
- Установленный Chrome
- логин и пароль в `.env` для работы автологина (либо вручную в хроме ввести с запуском `just man`)
- Внутри браузера надо вручную установить расширение Erinome Godville UI+, указать нужные настройки крафта
- `just auto` или другие рецепты в `justfile`

## Особенности

- При ошибках парсинга сохраняется исходный код и скриншот страницы. Выводится traceback питона в stdout и в логи.
- Легкое переключение между ручным, автоматическим с окном и автоматическим headless режимом (рецепты в `justfile`).
- Классы стараются выполнять только свою функцию, поэтому их немало, но так более понятно.
- Состояния (счетчик разворотов, бинго, время влияний и гласов) записываются в файл, чтобы при перезапуске корректно подгрузить прогресс. Профиль браузера переиспользуется, чтобы сохранить авторизацию.
- Тесты покрывают базовую часть, так как остальные части сложней тестировать и писать их легче при честно протестированных базовых классах.
- Информация со страницы кэшируется (1 сек), чтобы ускорить проверку условий для стратегий.
